[{"id":"3990c6a1.c2f82a","type":"tab","label":"Twin digital bridge","disabled":false,"info":""},{"id":"226c8060.a156","type":"mqtt in","z":"3990c6a1.c2f82a","name":"","topic":"status","qos":"0","datatype":"json","broker":"65126e38.f3208","x":70,"y":980,"wires":[["5a9ed8a3.4d2ff8","4abab149.2f425"]]},{"id":"db49a591.a38508","type":"ui_gauge","z":"3990c6a1.c2f82a","name":"","group":"e880180c.5e45f8","order":17,"width":4,"height":4,"gtype":"gage","title":"Wind speed","label":"m/s","format":"{{value}}","min":0,"max":"120","colors":["#00b500","#e6e600","#ca3838"],"seg1":"40","seg2":"80","x":1730,"y":1560,"wires":[]},{"id":"d34ec111.9ab01","type":"ui_gauge","z":"3990c6a1.c2f82a","name":"","group":"e880180c.5e45f8","order":24,"width":4,"height":4,"gtype":"gage","title":"Temperature","label":"C","format":"{{value}}","min":"-30","max":"70","colors":["#7ef3fb","#00b500","#ca3838"],"seg1":"10","seg2":"40","x":1730,"y":1600,"wires":[]},{"id":"11523286.49869d","type":"ui_gauge","z":"3990c6a1.c2f82a","name":"","group":"e880180c.5e45f8","order":18,"width":4,"height":4,"gtype":"gage","title":"Relative humidity","label":"%","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1750,"y":1640,"wires":[]},{"id":"e1b52047.71b09","type":"ui_gauge","z":"3990c6a1.c2f82a","name":"","group":"e880180c.5e45f8","order":25,"width":4,"height":4,"gtype":"wave","title":"Rain amount","label":"mm/day","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"3","seg2":"6","x":1730,"y":1680,"wires":[]},{"id":"b2cd9378.df27e","type":"switch","z":"3990c6a1.c2f82a","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"timestamp","vt":"str"},{"t":"eq","v":"sensor_id","vt":"str"},{"t":"eq","v":"long_rot","vt":"str"},{"t":"eq","v":"tran_rot","vt":"str"},{"t":"eq","v":"wind","vt":"str"},{"t":"eq","v":"temp_air","vt":"str"},{"t":"eq","v":"relh_air","vt":"str"},{"t":"eq","v":"rain","vt":"str"}],"checkall":"true","repair":false,"outputs":8,"x":1490,"y":1520,"wires":[["c1d41468.4075f8"],["444a64c5.751b9c"],["c118d55d.20cbf8"],["223884cb.571b1c"],["db49a591.a38508"],["d34ec111.9ab01"],["11523286.49869d"],["e1b52047.71b09"]]},{"id":"fa621560.820cf8","type":"split","z":"3990c6a1.c2f82a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":1350,"y":1520,"wires":[["b2cd9378.df27e"]]},{"id":"c118d55d.20cbf8","type":"ui_gauge","z":"3990c6a1.c2f82a","name":"","group":"e880180c.5e45f8","order":15,"width":4,"height":4,"gtype":"gage","title":"Longitudinal rotation","label":"°","format":"{{value}}","min":"-90","max":"90","colors":["#ca3838","#00e608","#ca3838"],"seg1":"-5","seg2":"5","x":1760,"y":1440,"wires":[]},{"id":"223884cb.571b1c","type":"ui_gauge","z":"3990c6a1.c2f82a","name":"","group":"e880180c.5e45f8","order":22,"width":4,"height":4,"gtype":"gage","title":"Transversal rotation","label":"°","format":"{{value}}","min":"-90","max":"90","colors":["#ca3838","#0ec42c","#ca3838"],"seg1":"-5","seg2":"5","x":1750,"y":1480,"wires":[]},{"id":"4a09982a.ff8b78","type":"ui_slider","z":"3990c6a1.c2f82a","name":"","label":"Longitudinal rotation","tooltip":"","group":"ad187510.0dc298","order":4,"width":0,"height":0,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":"-90","max":"90","step":"0.5","x":1620,"y":220,"wires":[["b32290f6.e4c32"]]},{"id":"e4781aa8.d307f8","type":"ui_slider","z":"3990c6a1.c2f82a","name":"","label":"Transversal rotation","tooltip":"","group":"ad187510.0dc298","order":5,"width":0,"height":0,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":"-90","max":"90","step":"0.5","x":1610,"y":260,"wires":[["14d9d375.5199ed"]]},{"id":"1bb60c4f.2655f4","type":"ui_slider","z":"3990c6a1.c2f82a","name":"","label":"Wind speed","tooltip":"","group":"ad187510.0dc298","order":6,"width":0,"height":0,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":0,"max":"120","step":"0.5","x":1590,"y":300,"wires":[["ddd68458.13d008"]]},{"id":"5ad82f4a.d1b46","type":"ui_slider","z":"3990c6a1.c2f82a","name":"","label":"Temperature","tooltip":"","group":"ad187510.0dc298","order":7,"width":0,"height":0,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":"-30","max":"70","step":"0.5","x":1590,"y":340,"wires":[["ac4ca200.c7855"]]},{"id":"f934af70.bc24f","type":"ui_slider","z":"3990c6a1.c2f82a","name":"","label":"Relative humidity","tooltip":"","group":"ad187510.0dc298","order":8,"width":0,"height":0,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":0,"max":"100","step":"0.5","x":1610,"y":380,"wires":[["e2019d27.55058"]]},{"id":"b60f522c.10f86","type":"ui_slider","z":"3990c6a1.c2f82a","name":"","label":"Rain amount","tooltip":"","group":"ad187510.0dc298","order":9,"width":0,"height":0,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":0,"max":"100","step":"0.5","x":1590,"y":420,"wires":[["1f388ea3.cbf4a1"]]},{"id":"b32290f6.e4c32","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.long_rot","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2030,"y":220,"wires":[[]]},{"id":"14d9d375.5199ed","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.tran_rot","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2030,"y":260,"wires":[[]]},{"id":"ddd68458.13d008","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.wind","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2020,"y":300,"wires":[[]]},{"id":"ac4ca200.c7855","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.temp_air","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2030,"y":340,"wires":[[]]},{"id":"e2019d27.55058","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.relh_air","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2030,"y":380,"wires":[[]]},{"id":"1f388ea3.cbf4a1","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.rain","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2020,"y":421,"wires":[[]]},{"id":"4c2fc03.e36aa4","type":"ui_toast","z":"3990c6a1.c2f82a","position":"bottom left","displayTime":"1.5","highlight":"","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"topic":"","name":"","x":470,"y":200,"wires":[]},{"id":"3a4bf596.ebdaba","type":"change","z":"3990c6a1.c2f82a","name":"Values Sent!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Values Sent!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":180,"wires":[["4c2fc03.e36aa4"]]},{"id":"4e642217.b5e44c","type":"mqtt out","z":"3990c6a1.c2f82a","name":"","topic":"status","qos":"","retain":"","broker":"65126e38.f3208","x":250,"y":100,"wires":[]},{"id":"cc68d68e.03db58","type":"ui_button","z":"3990c6a1.c2f82a","name":"","group":"ad187510.0dc298","order":10,"width":0,"height":0,"passthru":false,"label":"Send","tooltip":"","color":"#00FF00","bgcolor":"#008080","icon":"cloud_upload","payload":"template","payloadType":"flow","topic":"topic","topicType":"msg","x":90,"y":140,"wires":[["4e642217.b5e44c","3a4bf596.ebdaba"]]},{"id":"ec2ff0f9.76b4a","type":"ui_text","z":"3990c6a1.c2f82a","group":"e880180c.5e45f8","order":11,"width":4,"height":1,"name":"","label":"Rotations","format":"","layout":"col-center","x":1920,"y":1620,"wires":[]},{"id":"b4571030.bd16c","type":"ui_text","z":"3990c6a1.c2f82a","group":"e880180c.5e45f8","order":13,"width":4,"height":1,"name":"","label":"Weather","format":"","layout":"col-center","x":1940,"y":1460,"wires":[]},{"id":"19ec350.cf647cb","type":"comment","z":"3990c6a1.c2f82a","name":"Simulate sensor values","info":"","x":1800,"y":60,"wires":[]},{"id":"5e310fd1.d2141","type":"comment","z":"3990c6a1.c2f82a","name":"Dashboard","info":"","x":480,"y":820,"wires":[]},{"id":"444a64c5.751b9c","type":"ui_text","z":"3990c6a1.c2f82a","group":"e880180c.5e45f8","order":5,"width":5,"height":1,"name":"","label":"sensor number:","format":"{{msg.payload}}","layout":"row-spread","x":1740,"y":1380,"wires":[]},{"id":"c1d41468.4075f8","type":"ui_text","z":"3990c6a1.c2f82a","group":"e880180c.5e45f8","order":8,"width":7,"height":1,"name":"","label":"Last values received at:","format":"{{msg.payload}}","layout":"col-center","x":1770,"y":1340,"wires":[]},{"id":"7816b767.b79978","type":"ui_text","z":"3990c6a1.c2f82a","group":"e880180c.5e45f8","order":2,"width":5,"height":1,"name":"","label":"General","format":"","layout":"col-center","x":1960,"y":1360,"wires":[]},{"id":"53a8597.028bda8","type":"ui_date_picker","z":"3990c6a1.c2f82a","name":"","label":"","group":"ad187510.0dc298","order":3,"width":4,"height":1,"passthru":false,"topic":"topic","topicType":"msg","x":1590,"y":180,"wires":[["d5e58f90.7a14e"]]},{"id":"6357a452.641b0c","type":"ui_text_input","z":"3990c6a1.c2f82a","name":"","label":"Sensor_id:","tooltip":"","group":"ad187510.0dc298","order":1,"width":0,"height":0,"passthru":false,"mode":"number","delay":"1","topic":"topic","topicType":"msg","x":1590,"y":100,"wires":[["33a7137d.1c74ec"]]},{"id":"9a2ac4c1.1c2008","type":"ui_text_input","z":"3990c6a1.c2f82a","name":"","label":"","tooltip":"","group":"ad187510.0dc298","order":2,"width":3,"height":1,"passthru":false,"mode":"time","delay":"1","topic":"topic","topicType":"msg","x":1580,"y":140,"wires":[["9e0d394.80eebc8"]]},{"id":"33a7137d.1c74ec","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.sensor_id","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2040,"y":100,"wires":[[]]},{"id":"18eef8ca.844af7","type":"function","z":"3990c6a1.c2f82a","name":"set msg.template.timestamp","func":"time = flow.get(\"template.timestamp\").substring(11)\n\ntemp = msg.payload + \"-\" + time\n\nflow.set(\"template.timestamp\", temp)\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2040,"y":180,"wires":[[]]},{"id":"222cb335.c3f08c","type":"function","z":"3990c6a1.c2f82a","name":"set flow.template.timestamp","func":"date = flow.get(\"template.timestamp\").substring(0,10)\n\ntemp = date + \"-\" + msg.payload\n\nflow.set(\"template.timestamp\", temp)\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2040,"y":140,"wires":[[]]},{"id":"d5e58f90.7a14e","type":"moment","z":"3990c6a1.c2f82a","name":"Y-MM-DD","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Rome","adjAmount":0,"adjType":"days","adjDir":"add","format":"Y-MM-DD","locale":"it-IT","output":"payload","outputType":"msg","outTz":"Europe/Rome","x":1780,"y":180,"wires":[["18eef8ca.844af7"]]},{"id":"6ee42417.39153c","type":"ui_button","z":"3990c6a1.c2f82a","name":"Reset","group":"dba9ceab.22211","order":1,"width":0,"height":0,"passthru":false,"label":"","tooltip":"","color":"white","bgcolor":"#008080","icon":"refresh","payload":"","payloadType":"date","topic":"topic","topicType":"msg","x":90,"y":260,"wires":[["f78b09bf.601ea8","7824130b.357f2c","8aa9c682.4bbf58"]]},{"id":"f78b09bf.601ea8","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template","pt":"flow","to":"{\"sensor_id\":1,\"tran_rot\":0,\"long_rot\":0,\"wind\":0,\"temp_air\":0,\"relh_air\":0,\"rain\":0}","tot":"json"},{"t":"set","p":"enabled","pt":"msg","to":"true","tot":"bool"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":300,"wires":[["4a09982a.ff8b78","e4781aa8.d307f8","1bb60c4f.2655f4","5ad82f4a.d1b46","f934af70.bc24f","b60f522c.10f86"]]},{"id":"7824130b.357f2c","type":"moment","z":"3990c6a1.c2f82a","name":"Y-MM-DD-HH:mm","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Rome","adjAmount":0,"adjType":"days","adjDir":"add","format":"Y-MM-DD-HH:mm","locale":"it-IT","output":"template.timestamp","outputType":"flow","outTz":"Europe/Rome","x":910,"y":340,"wires":[[]]},{"id":"237a20c0.8bb56","type":"inject","z":"3990c6a1.c2f82a","name":"REPEAT","props":[],"repeat":"0.5","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":1040,"y":160,"wires":[["33f29cbf.23aea4"]]},{"id":"33f29cbf.23aea4","type":"function","z":"3990c6a1.c2f82a","name":"Consistent Display","func":"T = flow.get(\"template\")\nif(T){\n    date = T.timestamp.substring(0,10)\n    time = T.timestamp.substring(11)\n    \n    msg0 = {payload : T.sensor_id}\n    msg1 = {payload : time}\n    msg2 = {payload : date}\n    msg3 = {payload : T.long_rot}\n    msg4 = {payload : T.tran_rot}\n    msg5 = {payload : T.wind}\n    msg6 = {payload : T.temp_air}\n    msg7 = {payload : T.relh_air}\n    msg8 = {payload : T.rain}\n    \n    return [msg0,msg1,msg2,msg3,msg4,msg5,msg6,msg7,msg8]\n}","outputs":9,"noerr":0,"initialize":"","finalize":"","x":1230,"y":160,"wires":[["6357a452.641b0c"],["9a2ac4c1.1c2008"],["53a8597.028bda8"],["4a09982a.ff8b78"],["e4781aa8.d307f8"],["1bb60c4f.2655f4"],["5ad82f4a.d1b46"],["f934af70.bc24f"],["b60f522c.10f86"]]},{"id":"9e0d394.80eebc8","type":"moment","z":"3990c6a1.c2f82a","name":"HH:mm","topic":"","input":"payload","inputType":"msg","inTz":"Etc/GMT","adjAmount":0,"adjType":"days","adjDir":"add","format":"HH:mm","locale":"it-IT","output":"payload","outputType":"msg","outTz":"Etc/GMT","x":1780,"y":140,"wires":[["222cb335.c3f08c"]]},{"id":"72a707a0.3637e8","type":"comment","z":"3990c6a1.c2f82a","name":"Buttons","info":"","x":250,"y":40,"wires":[]},{"id":"8aa9c682.4bbf58","type":"change","z":"3990c6a1.c2f82a","name":"Values Reset!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Values Reset!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":260,"y":220,"wires":[["4c2fc03.e36aa4"]]},{"id":"c96ff1e2.c2a14","type":"ui_ui_control","z":"3990c6a1.c2f82a","name":"INIT on tab change","events":"all","x":270,"y":320,"wires":[["f78b09bf.601ea8","a73e86e0.427758"]]},{"id":"a73e86e0.427758","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":340,"wires":[["7824130b.357f2c"]]},{"id":"a5f6e16b.1975e","type":"function","z":"3990c6a1.c2f82a","name":"Is the Alert Triggered?","func":"A = global.get(\"alert\")\ntriggered = false\n\nif (A.sensor_id == null || A.sensor_id == msg.payload.sensor_id){\n    \n    C = A.conditions.split(',')\n    triggered = true\n    \n    for (var k in C){\n        i = C[k]\n        if(triggered){\n            between = false\n            offset = 2\n            idx = i.indexOf(\"<\")\n            \n            if (idx == -1){\n                idx = i.indexOf(\">\")\n                \n                if(idx == -1){ //found \"==\"\n                    idx = i.indexOf(\"=\")\n                    \n                    \n                }else{\n                    if(i.indexOf(\"=\") == -1){ //found \">\"\n                        offset--\n                    }\n                    \n                }\n            }else{\n                if(i.indexOf(\">\") == -1){\n                    if(i.indexOf(\"=\") == -1){ //found \"<\"\n                        offset--\n                    }\n                }else{ //found \"<>\"\n                    between = true\n                }\n            }\n\n            left = i.substring(0,idx)\n            right = i.substring(idx+offset)\n            \n            if(between){\n                andx = right.indexOf(\"&\")\n                \n                num1 = Number(right.substring(0,andx))\n                num2 = Number(right.substring(andx+1))\n                \n                if(num1 > num2){\n                    temp = num1\n                    num1 = num2\n                    num2 = temp\n                }\n                \n                \n            }else{\n                num1 = Number(right)\n            }\n            \n            switch(i.substring(idx,idx+offset)){\n                case \">=\": if(msg.payload[left] < num1){\n                            triggered = false}\n                            break;\n                case \">\":  if(msg.payload[left] <= num1){\n                            triggered = false}\n                            break;\n                case \"==\": if(msg.payload[left] != num1){\n                            triggered = false}\n                            break;\n                case \"<\":  if(msg.payload[left] >= num1){\n                            triggered = false}\n                            break;\n                case \"<=\": if(msg.payload[left] > num1){\n                            triggered = false}\n                            break;\n                case \"<>\": if((msg.payload[left] < num1) || (msg.payload[left] > num2)){\n                            triggered = false}\n                            break;\n            }\n        }\n    }\n\n    \n}\n\nmsg.triggered = triggered\n\nmsg.payload = \"Sensor number: \" + msg.payload.sensor_id + \" has triggered the alarm number: \" + \"TODO\" + \"<br>\" + A.message\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":340,"y":1300,"wires":[["f6df7b8c.d837c8"]]},{"id":"520b4aba.4b9b44","type":"ui_toast","z":"3990c6a1.c2f82a","position":"dialog","displayTime":"3","highlight":"","sendall":true,"outputs":1,"ok":"OK","cancel":"","raw":true,"topic":"","name":"","x":930,"y":1300,"wires":[[]]},{"id":"f6df7b8c.d837c8","type":"switch","z":"3990c6a1.c2f82a","name":"","property":"triggered","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":1300,"wires":[["520b4aba.4b9b44"]]},{"id":"1c2e28f6.d24887","type":"comment","z":"3990c6a1.c2f82a","name":"Alerts checking and triggering","info":"","x":500,"y":1180,"wires":[]},{"id":"42e075f9.fcaf4c","type":"ui_button","z":"3990c6a1.c2f82a","name":"","group":"dba9ceab.22211","order":2,"width":0,"height":0,"passthru":false,"label":"Malfunction","tooltip":"","color":"#FF0000","bgcolor":"#008080","icon":"mood_bad","payload":"","payloadType":"date","topic":"payload","topicType":"msg","x":110,"y":520,"wires":[["10a83450.bc4a6c"]]},{"id":"10a83450.bc4a6c","type":"function","z":"3990c6a1.c2f82a","name":"Random failures","func":"msg0 = {enabled : ((Math.floor(Math.random()*2))>0) ? true : false}\nmsg1 = {enabled : ((Math.floor(Math.random()*2))>0) ? true : false}\nmsg2 = {enabled : ((Math.floor(Math.random()*2))>0) ? true : false}\nmsg3 = {enabled : ((Math.floor(Math.random()*2))>0) ? true : false}\nmsg4 = {enabled : ((Math.floor(Math.random()*2))>0) ? true : false}\nmsg5 = {enabled : ((Math.floor(Math.random()*2))>0) ? true : false}\n\nreturn [msg0,msg1,msg2,msg3,msg4,msg5];","outputs":6,"noerr":0,"initialize":"","finalize":"","x":800,"y":520,"wires":[["b76439f0.9bbff8"],["7e89e60b.444928"],["fcff0013.f0c6"],["21a00b48.8bb8a4"],["8e4a96a6.9d9c08"],["b7bf0a30.f3c0f8"]]},{"id":"44d448a.1abb0b8","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.long_rot","pt":"flow","to":"null","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1250,"y":420,"wires":[["4a09982a.ff8b78"]]},{"id":"94b6a684.be3508","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.tran_rot","pt":"flow","to":"null","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1250,"y":460,"wires":[["e4781aa8.d307f8"]]},{"id":"9cec5a18.92f438","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.wind","pt":"flow","to":"null","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":500,"wires":[["1bb60c4f.2655f4"]]},{"id":"ec7993c8.5a5d2","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.temp_air","pt":"flow","to":"null","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1250,"y":540,"wires":[["5ad82f4a.d1b46"]]},{"id":"24d530a9.5cace","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.relh_air","pt":"flow","to":"null","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1250,"y":580,"wires":[["f934af70.bc24f"]]},{"id":"8465849a.0e21b8","type":"change","z":"3990c6a1.c2f82a","name":"","rules":[{"t":"set","p":"template.rain","pt":"flow","to":"null","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":620,"wires":[["b60f522c.10f86"]]},{"id":"b3153ba.3a598c8","type":"function","z":"3990c6a1.c2f82a","name":"Is the Sensor malfunctioning?","func":"msg.triggered = (msg.payload.long_rot == null || msg.payload.tran_rot == null ||\n                 msg.payload.wind == null || msg.payload.temp_air == null ||\n                 msg.payload.relh_air == null || msg.payload.rain == null)\n\nmsg.topic = msg.payload.timestamp\nmsg.payload = msg.payload.sensor_id\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":1220,"wires":[["8cb03b8e.798f98"]]},{"id":"a8337ef0.96919","type":"ui_toast","z":"3990c6a1.c2f82a","position":"top right","displayTime":"2","highlight":"red","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"topic":"","name":"","x":950,"y":1220,"wires":[]},{"id":"8cb03b8e.798f98","type":"switch","z":"3990c6a1.c2f82a","name":"","property":"triggered","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":1220,"wires":[["f91bc3f0.e111f","cf9576d8.eeaed8"]]},{"id":"4fdb1001.3a376","type":"function","z":"3990c6a1.c2f82a","name":"Timestamp creation (if missing)","func":"if(!msg.payload.timestamp){\n    \n    const MyDate = new Date()\n\n    timestamp = MyDate.getFullYear() + '-' +\n                ('0' + (MyDate.getMonth()+1)).slice(-2) + '-' +\n                ('0' + MyDate.getDate()).slice(-2) + '-' +\n                MyDate.getHours() + ':' +\n                MyDate.getMinutes()\n    \n    msg.payload.timestamp = timestamp\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":880,"wires":[["f972f6cd.b5b678"]]},{"id":"b76439f0.9bbff8","type":"switch","z":"3990c6a1.c2f82a","name":"disabled?","property":"enabled","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":420,"wires":[["44d448a.1abb0b8"]]},{"id":"7e89e60b.444928","type":"switch","z":"3990c6a1.c2f82a","name":"disabled?","property":"enabled","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":460,"wires":[["94b6a684.be3508"]]},{"id":"fcff0013.f0c6","type":"switch","z":"3990c6a1.c2f82a","name":"disabled?","property":"enabled","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":500,"wires":[["9cec5a18.92f438"]]},{"id":"21a00b48.8bb8a4","type":"switch","z":"3990c6a1.c2f82a","name":"disabled?","property":"enabled","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":540,"wires":[["ec7993c8.5a5d2"]]},{"id":"8e4a96a6.9d9c08","type":"switch","z":"3990c6a1.c2f82a","name":"disabled?","property":"enabled","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":580,"wires":[["24d530a9.5cace"]]},{"id":"b7bf0a30.f3c0f8","type":"switch","z":"3990c6a1.c2f82a","name":"disabled?","property":"enabled","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1020,"y":620,"wires":[["8465849a.0e21b8"]]},{"id":"7c95db12.4f0f94","type":"ui_text","z":"3990c6a1.c2f82a","group":"3517266d.d4724a","order":1,"width":6,"height":2,"name":"Simulation info 1","label":"","format":"Using this tab it is possible to simulate a sensor reading, every possibile sensor value is customizable between the valid minimum and maximum values.","layout":"col-center","x":1750,"y":540,"wires":[]},{"id":"78be449.3656ebc","type":"ui_text","z":"3990c6a1.c2f82a","group":"3517266d.d4724a","order":2,"width":6,"height":1,"name":"Simulation info 2","label":"","format":"The green send button will insert the readings to the database.","layout":"col-center","x":1750,"y":580,"wires":[]},{"id":"a7e07ae2.bc5588","type":"ui_text","z":"3990c6a1.c2f82a","group":"3517266d.d4724a","order":3,"width":6,"height":1,"name":"Simulation info 3","label":"","format":"The red malfunction button can simulate the possibility of random failures.","layout":"col-center","x":1750,"y":620,"wires":[]},{"id":"f992aeba.eb48e","type":"ui_text","z":"3990c6a1.c2f82a","group":"3517266d.d4724a","order":4,"width":6,"height":2,"name":"Simulation info 4","label":"","format":"Lastly the white reset button resets the values to their default, fixing any malfunction in the process.","layout":"col-center","x":1750,"y":660,"wires":[]},{"id":"3a54567c.f6a09a","type":"ui_text","z":"3990c6a1.c2f82a","group":"3517266d.d4724a","order":4,"width":"6","height":"1","name":"Simulation info 5","label":"","format":"After any change of tab the simulation is reset to default values.","layout":"col-center","x":1750,"y":700,"wires":[]},{"id":"c8f8afb8.e9eb6","type":"comment","z":"3990c6a1.c2f82a","name":"Simulation info texts","info":"","x":1750,"y":500,"wires":[]},{"id":"9742300b.14631","type":"ui_text","z":"3990c6a1.c2f82a","group":"cfc48e68.8d0e5","order":3,"width":6,"height":2,"name":"Readings  info 3","label":"","format":"When clicking on one entry of the list, its sensor readings will be shown in the gauges in the center.","layout":"col-center","x":1180,"y":1300,"wires":[]},{"id":"f69b26b2.992f68","type":"ui_text","z":"3990c6a1.c2f82a","group":"cfc48e68.8d0e5","order":2,"width":6,"height":2,"name":"Readings  info 2","label":"","format":"The list on the left shows the pair sensor_id and last detected timestamp of that sensor's reading.","layout":"col-center","x":1180,"y":1260,"wires":[]},{"id":"ebf82f14.561ac","type":"ui_text","z":"3990c6a1.c2f82a","group":"cfc48e68.8d0e5","order":1,"width":6,"height":1,"name":"Readings info 1","label":"","format":"Using this tab it is possible to visualize the last reading of  all sensors in the system.","layout":"col-center","x":1180,"y":1220,"wires":[]},{"id":"d6092596.fe3c48","type":"comment","z":"3990c6a1.c2f82a","name":"Readings info texts","info":"","x":1190,"y":1180,"wires":[]},{"id":"652d8c33.eb7294","type":"sqlite","z":"3990c6a1.c2f82a","mydb":"5f6a2dca.57ef14","sqlquery":"msg.topic","sql":"","name":"DATABASE","x":930,"y":1060,"wires":[[]]},{"id":"f972f6cd.b5b678","type":"function","z":"3990c6a1.c2f82a","name":"INSERT  measures INTO DB","func":"if(msg.payload.sensor_id != undefined){\n    command = \"INSERT INTO measures( timestamp, sensor_id, long_rot, tran_rot, wind, temp_air, relh_air, rain) VALUES( \"\n    \n    command += \"\\\"\" + msg.payload.timestamp + \"\\\", \"\n            +  msg.payload.sensor_id + \", \"\n            +  msg.payload.long_rot + \", \"\n            +  msg.payload.tran_rot + \", \"\n            +  msg.payload.wind + \", \"\n            +  msg.payload.temp_air + \", \"\n            +  msg.payload.relh_air + \", \"\n            +  msg.payload.rain + \")\"\n            \n    \n    msg.topic = command\n    \n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":1040,"wires":[["652d8c33.eb7294","71f96cd9.685fa4"]]},{"id":"f91bc3f0.e111f","type":"function","z":"3990c6a1.c2f82a","name":"UPDATE sensors IN DB","func":"\ncommand =  \"UPDATE sensors \"\ncommand += \"SET last_malfunction = \\\"\" + msg.topic + \"\\\" \"\ncommand += \"WHERE sensor_id = \" + msg.payload\n\nmsg.topic = command\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":710,"y":1080,"wires":[["652d8c33.eb7294"]]},{"id":"cf9576d8.eeaed8","type":"template","z":"3990c6a1.c2f82a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Sensor number: {{payload}} is malfunctioning.","output":"str","x":760,"y":1220,"wires":[["a8337ef0.96919"]]},{"id":"c52763f2.68e6","type":"sqlite","z":"3990c6a1.c2f82a","mydb":"5f6a2dca.57ef14","sqlquery":"msg.topic","sql":"","name":"DATABASE","x":1750,"y":1160,"wires":[["c06304f4.2c96e8"]]},{"id":"c06304f4.2c96e8","type":"ui_table","z":"3990c6a1.c2f82a","group":"7e1253e1.ee2acc","name":"Measures list","order":1,"width":"20","height":"10","columns":[{"field":"sensor_id","title":"Sensor ID","width":"9%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"timestamp","title":"Timestamp","width":"12%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"long_rot","title":"Longitudinal rotation","width":"18%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"tran_rot","title":"Transversal rotation","width":"15%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"wind","title":"Wind speed","width":"10%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"temp_air","title":"Temperature","width":"11%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"relh_air","title":"Relative humidity","width":"14%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"rain","title":"Rain amount","width":"11%","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}}],"outputs":0,"cts":false,"x":1910,"y":1100,"wires":[]},{"id":"780faef6.59244","type":"ui_ui_control","z":"3990c6a1.c2f82a","name":"","events":"change","x":1540,"y":1160,"wires":[["80b6f7c5.f47d08"]]},{"id":"80b6f7c5.f47d08","type":"function","z":"3990c6a1.c2f82a","name":"SELECT measures FROM DB","func":"\ncommand = \"SELECT * FROM measures\"\n\nmsg.topic = command\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":1100,"wires":[["c52763f2.68e6"]]},{"id":"6601ad72.c82ca4","type":"comment","z":"3990c6a1.c2f82a","name":"History of measurements","info":"","x":1750,"y":1060,"wires":[]},{"id":"5a9ed8a3.4d2ff8","type":"debug","z":"3990c6a1.c2f82a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":90,"y":1080,"wires":[]},{"id":"4abab149.2f425","type":"switch","z":"3990c6a1.c2f82a","name":"","property":"retain","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":210,"y":980,"wires":[["4fdb1001.3a376","b3153ba.3a598c8","a5f6e16b.1975e"]]},{"id":"71f96cd9.685fa4","type":"debug","z":"3990c6a1.c2f82a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":930,"y":1000,"wires":[]},{"id":"d49d18b0.a54528","type":"ui_table","z":"3990c6a1.c2f82a","group":"18f79e2c.768552","name":"Sensors list","order":3,"width":"8","height":"6","columns":[{"field":"sensor_id","title":"Sensor ID","width":"","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"timestamp","title":"Last reading","width":"","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"last_malfunction","title":"Last malfunction","width":"","align":"center","formatter":"plaintext","formatterParams":{"target":"_blank"}}],"outputs":1,"cts":true,"x":1130,"y":1520,"wires":[["fa621560.820cf8"]]},{"id":"4161827f.3a732c","type":"sqlite","z":"3990c6a1.c2f82a","mydb":"5f6a2dca.57ef14","sqlquery":"msg.topic","sql":"","name":"DATABASE","x":850,"y":1520,"wires":[["d49d18b0.a54528","b62f3778.235628","192eb31a.8b97bd"]]},{"id":"192eb31a.8b97bd","type":"debug","z":"3990c6a1.c2f82a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1210,"y":1620,"wires":[]},{"id":"bb14d3c6.fc883","type":"ui_button","z":"3990c6a1.c2f82a","name":"Add sensor","group":"18f79e2c.768552","order":1,"width":1,"height":1,"passthru":false,"label":"","tooltip":"","color":"#00FF00","bgcolor":"#008080","icon":"add","payload":"","payloadType":"date","topic":"topic","topicType":"msg","x":330,"y":1420,"wires":[["2d78bd1f.57a122"]]},{"id":"2d78bd1f.57a122","type":"function","z":"3990c6a1.c2f82a","name":"INSERT sensors INTO DB","func":"A = global.get(\"sensor_num\") + 1\nglobal.set(\"sensor_num\", A)\n\ncommand = \"INSERT INTO sensors (sensor_id, last_malfunction) VALUES (\"\n\ncommand += A + \", \"\n        +  null + \")\"\n        \nmsg.topic = command\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":1420,"wires":[["4161827f.3a732c"]]},{"id":"2383496c.bb55c6","type":"function","z":"3990c6a1.c2f82a","name":"SELECT sensors FROM DB","func":"\ncommand = \"SELECT sensors.sensor_id, long_rot, tran_rot, wind, temp_air, relh_air, rain, \" \ncommand += \"last_malfunction, MAX(timestamp) AS timestamp FROM sensors \"\ncommand += \"LEFT JOIN measures ON sensors.sensor_id = measures.sensor_id \"\ncommand += \"GROUP BY sensors.sensor_id \"\n\n\nmsg.topic = command\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":1640,"wires":[["4161827f.3a732c"]]},{"id":"2e40ba42.4851c6","type":"ui_ui_control","z":"3990c6a1.c2f82a","name":"","events":"change","x":320,"y":1640,"wires":[["2383496c.bb55c6"]]},{"id":"b62f3778.235628","type":"switch","z":"3990c6a1.c2f82a","name":"Just inserted?","property":"payload","propertyType":"msg","rules":[{"t":"empty"}],"checkall":"true","repair":false,"outputs":1,"x":860,"y":1700,"wires":[["2383496c.bb55c6"]]},{"id":"65126e38.f3208","type":"mqtt-broker","name":"","broker":"test.mosquitto.org","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"e880180c.5e45f8","type":"ui_group","name":"Gauges","tab":"2c91f384.f52dfc","order":2,"disp":true,"width":"13","collapse":false},{"id":"ad187510.0dc298","type":"ui_group","name":"Sensor readings","tab":"27392637.24c19a","order":2,"disp":true,"width":7,"collapse":false},{"id":"dba9ceab.22211","type":"ui_group","name":"Actions","tab":"27392637.24c19a","order":1,"disp":true,"width":"3","collapse":false},{"id":"3517266d.d4724a","type":"ui_group","name":"Simulation info","tab":"27392637.24c19a","order":3,"disp":true,"width":6,"collapse":false},{"id":"cfc48e68.8d0e5","type":"ui_group","name":"Readings info","tab":"2c91f384.f52dfc","order":3,"disp":true,"width":"6","collapse":false},{"id":"5f6a2dca.57ef14","type":"sqlitedb","db":"E:\\GitHubDesktop\\Repos\\IoT-Twin-Digital-Bridge\\TDB.sqlite","mode":"RWC"},{"id":"7e1253e1.ee2acc","type":"ui_group","name":"Past Sensor Readings","tab":"ba34c212.a4d14","order":1,"disp":true,"width":"20","collapse":false},{"id":"18f79e2c.768552","type":"ui_group","name":"Sensors list","tab":"2c91f384.f52dfc","order":1,"disp":true,"width":"8","collapse":false},{"id":"2c91f384.f52dfc","type":"ui_tab","name":"Last readings","icon":"network_check","disabled":false,"hidden":false},{"id":"27392637.24c19a","type":"ui_tab","name":"Sensor simulation","icon":"list","order":2,"disabled":false,"hidden":false},{"id":"ba34c212.a4d14","type":"ui_tab","name":"Readings History","icon":"history","disabled":false,"hidden":false}]